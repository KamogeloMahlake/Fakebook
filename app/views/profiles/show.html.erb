<div class="posts-wrapper">
  <div class="row profile-header">
    <div class="col-md-6">
      <div style="display: flex; flex-direction: column; justify-content: center">
        <% if @user.image.attached? %>
          <%= image_tag(@user.image, class: "profile-image",  loading: :lazy ) %>
        <%else %>
          <%= image_tag(asset_path("avatarnew.png", class: "profile-image",  loading: :lazy ))%>
        <% end %>
        <h3 style="text-align: center" class="profile-user-name"><%= @user.user_name %></h3>

      </div>
    </div>

    <div class="col-md-6">

      <div style="display: flex; flex-direction: column; gap: 1rem; justify-content: space-between">
        <span>
          <% if @user == current_user %>
            <%= link_to 'Edit Profile', edit_profile_path(@user.user_name), class: "btn btn-primary" %>
          <% else %>
            <%= csrf_meta_tag %>
            <% if current_user_is_following(current_user.id, @user.id) %>
              <button class="btn btn-danger" id="unfollow-button">Unfollow</button>

            <% else%>
              <button class="btn btn-primary" id="unfollow-button">Follow</button>
            <% end %>
          <% end %>
        </span>
      </div>
      <div>
        <%= @user.bio %>
      </div>
      <div style="display: flex; justify-content: space-between">
        <p>
          <%= pluralize @user.posts.count, 'post' %>
        </p>

        <a href="/<%= @user.user_name %>/followers">
          <p id="followers"><%= pluralize @user.followers.count, 'follower' %></p>
        </a>

        <a href="/<%= @user.user_name %>/following">
          <p><%= @user.following.count%> following</p>
        </a>
      </div>
    </div>
  </div>
</div>

<div>
  <div>
    <% if @posts%>
      <% @posts.each do |post| %>
        <%= render 'posts/post', post: post %>
      <% end %>
    <% end %>
  </div>
</div>
<% unless current_user == @user %>
<script type="text/javascript">
    document.getElementById("unfollow-button").addEventListener('click', () => {
        let btnText = document.getElementById("unfollow-button").textContent === "Unfollow" ? "unfollow_user" : "follow_user";
        fetch(`/<%= @user.user_name %>/${btnText}`, {
            method: "POST",
            headers: {
                'X-CSRF-Token': document.getElementById("unfollow-button").parentElement.querySelector('meta[name="csrf-token"]').content
            }
        })
        .then(r => r.json())
        .then(d => {
            console.log(d);
            document.getElementById("unfollow-button").classList.toggle('btn-primary');
            document.getElementById("unfollow-button").classList.toggle('btn-danger');
            document.getElementById("unfollow-button").textContent = document.getElementById("unfollow-button").textContent === "Unfollow" ? 'Follow' : 'Unfollow';
            document.getElementById('followers').textContent = d.count === 1 ? `${d.count} follower` : `${d.count ? d.count : 0} followers`

        })
    })
</script>
<% end %>